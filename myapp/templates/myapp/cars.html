{% extends 'myapp/base.html' %}
{% load static %}

{% block title %}Our Cars - Car Rental System{% endblock %}

{% block content %}
<div class="cars-hero">
  <h1>Our Premium Fleet</h1>
  <p>Choose from our wide selection of quality vehicles</p>
</div>

<main class="cars-page">
  <div class="cars-header">
    <div class="search-filter-container">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="Search cars..." id="searchCars" />
      </div>
      <div class="filters">
        <select id="availabilityFilter" class="filter-select">
          <option value="all">All Cars</option>
          <option value="available">Available Cars</option>
          <option value="rented">Rented Cars</option>
        </select>
        {% if can_add_car %}
        <button onclick="showAddCarModal()" class="add-car-btn">
          <i class="fas fa-plus"></i> Add New Car
        </button>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="car-grid">
    {% for car in cars %}
    <div class="car-card">
      <img src="{{ car.image.url }}" alt="{{ car.model }}" />
      <div class="car-info">
        <h3>{{ car.model }}</h3>
        <p class="price">${{ car.price_per_day }} per day</p>
        <p class="status {% if car.available %}available{% else %}rented{% endif %}">
          {% if car.available %}● Available{% else %}● Currently Rented{% endif %}
        </p>
        <div class="car-actions">
          {% if car.available %}
          {% if perms.myapp.add_rental %}
          <button onclick="rentCar('{{ car.id }}')" class="rent-btn">
            Rent Now
          </button>
          {% endif %}
          {% else %}
          {% if perms.myapp.change_rental %}
          <button onclick="returnCar('{{ car.id }}')" class="return-btn">
            Return Car
          </button>
          {% endif %}
          {% endif %}
          {% if perms.myapp.delete_car %}
          <button onclick="deleteCar('{{ car.id }}')" class="delete-btn">
            <i class="fas fa-trash"></i>
          </button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% if perms.myapp.view_rental %}
  <section id="rentals-section">
    <div class="section-header">
      <h2><i class="fas fa-clipboard-list"></i> Current Rentals</h2>
    </div>
    <div class="rentals-list">
      {% for rental in rentals %}
      <div class="rental-item">
        <div class="rental-info">
          <h3>{{ rental.car.model }}</h3>
          <p>Customer: {{ rental.customer.name }}</p>
          <p>Phone: {{ rental.customer.phone_number }}</p>
          <p>Email: {{ rental.customer.email }}</p>
          <p>Rental Date: {{ rental.rental_date }}</p>
          <p>Duration: {{ rental.number_of_days }} days</p>
          <p>Total Price: ${{ rental.total_price }}</p>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}
</main>

<!-- Add Car Modal -->
{% if can_add_car %}
<div id="addCarModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2><i class="fas fa-car"></i> Add New Car</h2>
      <button onclick="closeModal()" class="close-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form method="post" action="{% url 'add_car' %}" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="form-group">
        <label for="carModel">
          <i class="fas fa-car-side"></i> Car Model
        </label>
        <input type="text" id="carModel" name="carModel" required />
      </div>
      <div class="form-group">
        <label for="carImage">
          <i class="fas fa-image"></i> Car Image
        </label>
        <input type="file" id="carImage" name="carImage" accept="image/*" required />
      </div>
      <div class="form-group">
        <label for="carPrice">
          <i class="fas fa-tag"></i> Price per Day ($)
        </label>
        <input type="number" id="carPrice" name="carPrice" required />
      </div>
      <div class="modal-actions">
        <button type="submit" class="submit-btn">
          <i class="fas fa-plus"></i> Add Car
        </button>
        <button type="button" onclick="closeModal()" class="cancel-btn">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<!-- Rent Car Modal -->
{% if perms.myapp.add_rental %}
<div id="rentCarModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2><i class="fas fa-key"></i> Rent Car</h2>
      <button onclick="closeModal()" class="close-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form method="post" action="" id="rentCarForm">
      {% csrf_token %}
      <div class="form-group">
        <label><i class="fas fa-user"></i> Customer Name</label>
        <input type="text" name="customerName" placeholder="Enter customer name" required />
      </div>
      <div class="form-group">
        <label><i class="fas fa-phone"></i> Phone Number</label>
        <input type="tel" name="phoneNumber" placeholder="Enter phone number" required />
      </div>
      <div class="form-group">
        <label><i class="fas fa-envelope"></i> Email</label>
        <input type="email" name="email" placeholder="Enter email address" required />
      </div>
      <div class="form-group">
        <label><i class="fas fa-calendar"></i> Rental Date</label>
        <input type="date" name="rentalDate" required min="{{ today|date:'Y-m-d' }}" />
      </div>
      <div class="form-group">
        <label><i class="fas fa-clock"></i> Number of Days</label>
        <input type="number" name="numberOfDays" placeholder="Enter number of days" required min="1" />
      </div>
      
      <div class="modal-actions">
        <button type="submit" class="submit-btn">
          <i class="fas fa-check"></i> Confirm Rental
        </button>
        <button type="button" onclick="closeModal()" class="cancel-btn">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<script>
  // Add these variables at the top of your script
  const userPermissions = {
    canDeleteCar: {% if perms.myapp.delete_car %}true{% else %}false{% endif %},
    canAddCar: {% if perms.myapp.add_car %}true{% else %}false{% endif %},
    canRentCar: {% if perms.myapp.add_rental %}true{% else %}false{% endif %},
    canReturnCar: {% if perms.myapp.change_rental %}true{% else %}false{% endif %}
  };

  function showAddCarModal() {
    if (!userPermissions.canAddCar) {
      alert("You don't have permission to add cars.");
      return;
    }
    document.getElementById('addCarModal').style.display = 'block';
  }

  function closeModal() {
    document.getElementById('addCarModal').style.display = 'none';
    document.getElementById('rentCarModal').style.display = 'none';
  }

  function rentCar(carId) {
    if (!userPermissions.canRentCar) {
      alert("You don't have permission to rent cars.");
      return;
    }
    const modal = document.getElementById('rentCarModal');
    const form = document.getElementById('rentCarForm');
    form.action = `/rent_car/${carId}/`;
    modal.style.display = 'block';
  }

  function returnCar(carId) {
    if (!userPermissions.canReturnCar) {
      alert("You don't have permission to return cars.");
      return;
    }
    if (confirm('Are you sure you want to return this car?')) {
      window.location.href = `/return_car/${carId}/`;
    }
  }

  function deleteCar(carId) {
    if (!userPermissions.canDeleteCar) {
      alert("You don't have permission to delete cars.");
      return;
    }
    if (confirm('Are you sure you want to delete this car?')) {
      window.location.href = `/delete_car/${carId}/`;
    }
  }

  // Close modal when clicking outside
  window.onclick = function(event) {
    if (event.target.className === 'modal') {
      closeModal();
    }
  }
</script>
{% endblock %} 